
msladmin@xinshengw.partner.onmschina.cn
xinshengw.partner.onmschina.cn\msladmin
xinshengw.partner.onmschina.cn\mslavduser1
Microsoft2024

admin@xinshengw.partner.onmschina.cn


New-Item -ItemType Directory -Path "C:\Temp" -Force
Set-Location -Path "C:\Temp"
$Uri = "https://raw.githubusercontent.com/Azure/RDS-Templates/master/wvd-templates/wvd-scaling-script/CreateOrUpdateAzAutoAccount.ps1"
# Download the script
Invoke-WebRequest -Uri $Uri -OutFile ".\CreateOrUpdateAzAutoAccount.ps1"


$Params = @{
     "AADTenantId"           = "<Azure_Active_Directory_tenant_ID>"   # Optional. If not specified, it will use the current Azure context
     "SubscriptionId"        = "<Azure_subscription_ID>"              # Optional. If not specified, it will use the current Azure context
     "UseARMAPI"             = $true
     "ResourceGroupName"     = "<Resource_group_name>"                # Optional. Default: "WVDAutoScaleResourceGroup"
     "AutomationAccountName" = "<Automation_account_name>"            # Optional. Default: "WVDAutoScaleAutomationAccount"
     "Location"              = "<Azure_region_for_deployment>"
     "WorkspaceName"         = "<Log_analytics_workspace_name>"       # Optional. If specified, Log Analytics will be used to configure the custom log table that the runbook PowerShell script can send logs to
}

.\CreateOrUpdateAzAutoAccount.ps1 @Params



https://raw.githubusercontent.com/Azure/RDS-Templates/master/wvd-templates/wvd-scaling-script/basicScale.ps1

https://raw.githubusercontent.com/Azure/RDS-Templates/master/wvd-templates/wvd-scaling-script/runbookCreationTemplate.json




Connect-AzAccount -Environment AzureChinaCloud


New-Item -ItemType Directory -Path "C:\Temp" -Force
Set-Location -Path "C:\Temp"
$Uri = "https://raw.githubusercontent.com/Azure/RDS-Templates/master/wvd-templates/wvd-scaling-script/CreateOrUpdateAzLogicApp.ps1"
# Download the script
Invoke-WebRequest -Uri $Uri -OutFile ".\CreateOrUpdateAzLogicApp.ps1"


$LogAnalyticsWorkspaceId = Read-Host -Prompt "If you want to use Log Analytics, enter the Log Analytics Workspace ID returned by when you created the Azure Automation account, otherwise leave it blank"
$LogAnalyticsPrimaryKey = Read-Host -Prompt "If you want to use Log Analytics, enter the Log Analytics Primary Key returned by when you created the Azure Automation account, otherwise leave it blank"
$RecurrenceInterval = Read-Host -Prompt "Enter how often you'd like the job to run in minutes, e.g. '15'"
$BeginPeakTime = Read-Host -Prompt "Enter the start time for peak hours in local time, e.g. 9:00"
$EndPeakTime = Read-Host -Prompt "Enter the end time for peak hours in local time, e.g. 18:00"
$TimeDifference = Read-Host -Prompt "Enter the time difference between local time and UTC in hours, e.g. +5:30"
$SessionThresholdPerCPU = Read-Host -Prompt "Enter the maximum number of sessions per CPU that will be used as a threshold to determine when new session host VMs need to be started during peak hours"
$MinimumNumberOfRDSH = Read-Host -Prompt "Enter the minimum number of session host VMs to keep running during off-peak hours"
$MaintenanceTagName = Read-Host -Prompt "Enter the name of the Tag associated with VMs you don't want to be managed by this scaling tool"
$LimitSecondsToForceLogOffUser = Read-Host -Prompt "Enter the number of seconds to wait before automatically signing out users. If set to 0, any session host VM that has user sessions, will be left untouched"
$LogOffMessageTitle = Read-Host -Prompt "Enter the title of the message sent to the user before they are forced to sign out"
$LogOffMessageBody = Read-Host -Prompt "Enter the body of the message sent to the user before they are forced to sign out"

$WebhookURI = Read-Host -Prompt "Enter the webhook URI that has already been generated for this Azure Automation account. The URI is stored as encrypted in the above Automation Account variable. To retrieve the value, see https://learn.microsoft.com/azure/automation/shared-resources/variables?tabs=azure-powershell#powershell-cmdlets-to-access-variables"


eyJhbGciOiJSUzI1NiIsImtpZCI6IjRDODk4NkNGMURBOUFFMDFCQjFDRTg2NTcyQTc1RUUzNjY1MERBOTAiLCJ0eXAiOiJKV1QifQ.eyJSZWdpc3RyYXRpb25JZCI6ImY5ZTEwMTE0LTMxZjctNGE0MS05NjVhLTMxYWQ5Yjk5MWY4MSIsIkJyb2tlclVyaSI6Imh0dHBzOi8vcmRicm9rZXItZy1jbi1yMS53dmQuYXp1cmUuY24vIiwiRGlhZ25vc3RpY3NVcmkiOiJodHRwczovL3JkZGlhZ25vc3RpY3MtZy1jbi1yMS53dmQuYXp1cmUuY24vIiwiRW5kcG9pbnRQb29sSWQiOiJmZmZkNmRkYS02YzJiLTRjYjItOGQxNy0wY2RjZmRiZTEwZjQiLCJHbG9iYWxCcm9rZXJVcmkiOiJodHRwczovL3JkYnJva2VyLnd2ZC5henVyZS5jbi8iLCJHZW9ncmFwaHkiOiJDTiIsIkdsb2JhbEJyb2tlclJlc291cmNlSWRVcmkiOiJodHRwczovL2ZmZmQ2ZGRhLTZjMmItNGNiMi04ZDE3LTBjZGNmZGJlMTBmNC5yZGJyb2tlci53dmQuYXp1cmUuY24vIiwiQnJva2VyUmVzb3VyY2VJZFVyaSI6Imh0dHBzOi8vZmZmZDZkZGEtNmMyYi00Y2IyLThkMTctMGNkY2ZkYmUxMGY0LnJkYnJva2VyLWctY24tcjEud3ZkLmF6dXJlLmNuLyIsIkRpYWdub3N0aWNzUmVzb3VyY2VJZFVyaSI6Imh0dHBzOi8vZmZmZDZkZGEtNmMyYi00Y2IyLThkMTctMGNkY2ZkYmUxMGY0LnJkZGlhZ25vc3RpY3MtZy1jbi1yMS53dmQuYXp1cmUuY24vIiwiQUFEVGVuYW50SWQiOiI3MWFkZWU1ZC03YjRiLTRlNDctODgxNC1hZGUyYTk4NGE1NDMiLCJuYmYiOjE3MjUxNjYxMzYsImV4cCI6MTcyNTg5NzYwMCwiaXNzIjoiUkRJbmZyYVRva2VuTWFuYWdlciIsImF1ZCI6IlJEbWkifQ.J-icwYFF5SLH_SSWzIAcJcHU1YeJUYP2mwTQepOwDYsUvROAZnOWosZTvAme1KpgeJD3P6GdXn0uJqd4ifLkYbL9mZQB_dT2pTyU91z7UoV8ClMDoZclQNDvtct2VOcZ45KmHgI1D6nrrW4gbxJKjFg54Ht9saNoL7iGgEM-3OnUxJEr3hv09WS3T3gGk6nRgdrZkqrfnAYLxMJRkIojZTHEFk8uzqshCjvmxWe0q7GWK-sC7jLIdWewhwcS9TTzQWAF43hTkzNaVmCoK3Uhj-JIh9ErHqKWYYY6tWO4ayQj3Rv5LkW9oNV9wf4JDzNIdUJb9FJg3SH05UIGhTHCsw


Write-Log "Number of user sessions: $nUserSessions of total allowed $($nRunningVMs * $HostPool.MaxSessionLimit)"


#[int]$MaxUserSessionsThresholdCapacity = [math]::Floor($nRunningVMs * $HostPool.MaxSessionLimit)




$Params = @{
	"AADTenantId"           = "71adee5d-7b4b-4e47-8814-ade2a984a543"
	"SubscriptionId"        = "15e95d2e-6cd0-4d1c-96da-b8e055a62ee8"
	"UseARMAPI"             = $true
	"ResourceGroupName"     = "mslavdrg"
	"AutomationAccountName" = "mslavdaa1new"
	"Location"              = "chinanorth3"
}

.\CreateOrUpdateAzAutoAccount.ps1 @Params






$AADTenantId = (Get-AzContext).Tenant.Id

$AzSubscription = Get-AzSubscription | Out-GridView -OutputMode:Single -Title "Select your Azure Subscription"
Select-AzSubscription -Subscription $AzSubscription.Id

$ResourceGroup = Get-AzResourceGroup | Out-GridView -OutputMode:Single -Title "Select the resource group for the new Azure Logic App"

$WVDHostPool = Get-AzResource -ResourceType "Microsoft.DesktopVirtualization/hostpools" | Out-GridView -OutputMode:Single -Title "Select the host pool you'd like to scale"

$LogAnalyticsWorkspaceId = Read-Host -Prompt "If you want to use Log Analytics, enter the Log Analytics Workspace ID returned by when you created the Azure Automation account, otherwise leave it blank"
$LogAnalyticsPrimaryKey = Read-Host -Prompt "If you want to use Log Analytics, enter the Log Analytics Primary Key returned by when you created the Azure Automation account, otherwise leave it blank"
$RecurrenceInterval = Read-Host -Prompt "Enter how often you'd like the job to run in minutes, e.g. '15'"
$BeginPeakTime = Read-Host -Prompt "Enter the start time for peak hours in local time, e.g. 9:00"
$EndPeakTime = Read-Host -Prompt "Enter the end time for peak hours in local time, e.g. 18:00"
$TimeDifference = Read-Host -Prompt "Enter the time difference between local time and UTC in hours, e.g. +5:30"
$SessionThresholdPerCPU = Read-Host -Prompt "Enter the maximum number of sessions per CPU that will be used as a threshold to determine when new session host VMs need to be started during peak hours"
$MinimumNumberOfRDSH = Read-Host -Prompt "Enter the minimum number of session host VMs to keep running during off-peak hours"
$MaintenanceTagName = Read-Host -Prompt "Enter the name of the Tag associated with VMs you don't want to be managed by this scaling tool"
$LimitSecondsToForceLogOffUser = Read-Host -Prompt "Enter the number of seconds to wait before automatically signing out users. If set to 0, any session host VM that has user sessions, will be left untouched"
$LogOffMessageTitle = Read-Host -Prompt "Enter the title of the message sent to the user before they are forced to sign out"
$LogOffMessageBody = Read-Host -Prompt "Enter the body of the message sent to the user before they are forced to sign out"

$WebhookURI = Read-Host -Prompt "Enter the webhook URI that has already been generated for this Azure Automation account. The URI is stored as encrypted in the above Automation Account variable. To retrieve the value, see https://learn.microsoft.com/azure/automation/shared-resources/variables?tabs=azure-powershell#powershell-cmdlets-to-access-variables"

$Params = @{
     "AADTenantId"                   = "71adee5d-7b4b-4e47-8814-ade2a984a543"
     "SubscriptionID"                = "15e95d2e-6cd0-4d1c-96da-b8e055a62ee8"
     "ResourceGroupName"             = "mslavdrg"
     "Location"                      = "chinanorth3"
     "UseARMAPI"                     = $true
     "HostPoolName"                  = "mslavdhp1"
     "HostPoolResourceGroupName"     = "mslavdrg"
     "RecurrenceInterval"            = "1"
     "BeginPeakTime"                 = "00:00"
     "EndPeakTime"                   = "23:59"
     "TimeDifference"                = "+8:00"
     "WebhookURI"                    = "https://a8f48ec3-aec5-42de-b320-815ee490b0bb.webhook.cnn3.azure-automation.cn/webhooks?token=IONkEIL2buvBpJO6Uwixzf9DqrbpkUDYw%2fLbrvsvjfA%3d"
}

.\CreateOrUpdateAzLogicApp.ps1 @Params

Bwang0920
Xinxin150912


admin@xinshengw.partner.onmschina.cn
msadmin
Microsoft2024

https://software-static.download.prss.microsoft.com/dbazure/988969d5-f34g-4e03-ac9d-1f9786c66749/22621.1.220506-1250.ni_release_amd64fre_CLIENT_LOF_PACKAGES_OEM.iso