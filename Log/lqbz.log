è¯·ç”Ÿæˆä¸€ä¸ªå®Œæ•´çš„æµ‹è¯•ç”¨ä¾‹ 

ä¸€å° Azure Linux VMï¼ˆæœ€å¥½æ˜¯çº¢å¸½ç³»çš„ï¼‰ï¼Œé€šè¿‡ Azure Monitor Agent ç›‘æ§åŸºç¡€çš„ Metricï¼ˆæ¯”å¦‚ CPU MEM NET DISK ç­‰ï¼‰ï¼Œç„¶åæƒ³é’ˆå¯¹è¿™äº›æŒ‡æ ‡åšè‡ªå®šä¹‰å‘Šè­¦ï¼Œå‚è€ƒçš„ Link ï¼šhttps://learn.microsoft.com/en-us/azure/azure-monitor/alerts/alerts-common-schema

èƒ½ä¸èƒ½ä» VM åˆ›å»ºå¼€å§‹ ä¸€ç›´åˆ° Common Alert Schema é…ç½®ï¼Œç«¯åˆ°ç«¯ç»™ä¸€ä¸ªå®Œæ•´çš„æµ‹è¯•ç”¨ä¾‹





RG="rg-ama-common-schema-demo"
LOCATION="eastasia"
VM_NAME="vm-rhel-demo"
VM_SIZE="Standard_B2s"
ADMIN_USER="azureuser"

DCR_NAME="dcr-${VM_NAME}-metrics"
DCR_NAME="dcr-vm-rhel-demo-metrics"
AG_NAME="ag-ama-common-schema"
AG_SHORT="AG-Common"
LOGIC_APP_NAME="la-alert-formatter"

EMAIL_TO="xinsheng.wang@outlook.com"



# 1) èµ„æºç»„
az group create --name $RG --location $LOCATION

# 2) åˆ›å»º RHEL VMï¼ˆç”Ÿæˆ SSH Keyï¼‰
az vm create \
  --resource-group $RG \
  --name $VM_NAME \
  --image RedHat:RHEL:9-lvm-gen2:latest \
  --size $VM_SIZE \
  --admin-username $ADMIN_USER \
  --authentication-type password \
  --admin-password "" \
  --public-ip-sku Standard

VM_ID=$(az vm show -g $RG -n $VM_NAME --query id -o tsv)

{
  "fqdns": "",
  "id": "/subscriptions/ba10fd82-edf7-4c96-8c6a-2f46085f56f2/resourceGroups/rg-ama-common-schema-demo/providers/Microsoft.Compute/virtualMachines/vm-rhel-demo",
  "location": "eastasia",
  "macAddress": "60-45-BD-56-64-C1",
  "powerState": "VM running",
  "privateIpAddress": "10.0.0.4",
  "publicIpAddress": "52.175.48.129",
  "resourceGroup": "rg-ama-common-schema-demo"
}


DCR_ID=$(az monitor data-collection rule show -g $RG -n $DCR_NAME --query id -o tsv)


az vm extension set -g $RG --vm-name $VM_NAME \
  --name AzureMonitorLinuxAgent \
  --publisher Microsoft.Azure.Monitor \
  --enable-auto-upgrade true

az monitor data-collection rule association create \
  --name "assoc-${VM_NAME}" \
  --resource $VM_ID \
  --rule-id $DCR_ID





{
  "schemaId": "azureMonitorCommonAlertSchema",
  "data": {
    "essentials": {
      "alertId": "/subscriptions/<subscription ID>/providers/Microsoft.AlertsManagement/alerts/aaaa0a0a-bb1b-cc2c-dd3d-eeeeee4e4e4e",
      "alertRule": "WCUS-R2-Gen2",
      "severity": "Sev3",
      "signalType": "Metric",
      "monitorCondition": "Resolved",
      "monitoringService": "Platform",
      "alertTargetIDs": [
        "/subscriptions/<subscription ID>/resourcegroups/pipelinealertrg/providers/microsoft.compute/virtualmachines/wcus-r2-gen2"
      ],
      "configurationItems": [
        "wcus-r2-gen2"
      ],
      "originAlertId": "3f2d4487-b0fc-4125-8bd5-7ad17384221e_PipeLineAlertRG_microsoft.insights_metricAlerts_WCUS-R2-Gen2_-117781227",
      "firedDateTime": "2019-03-22T13:58:24.3713213Z",
      "resolvedDateTime": "2019-03-22T14:03:16.2246313Z",
      "description": "",
      "essentialsVersion": "1.0",
      "alertContextVersion": "1.0"
    },
    "alertContext": {
      "properties": null,
      "conditionType": "SingleResourceMultipleMetricCriteria",
      "condition": {
        "windowSize": "PT5M",
        "allOf": [
          {
            "metricName": "Percentage CPU",
            "metricNamespace": "Microsoft.Compute/virtualMachines",
            "operator": "GreaterThan",
            "threshold": "25",
            "timeAggregation": "Average",
            "dimensions": [
              {
                "name": "ResourceId",
                "value": "3efad9dc-3d50-4eac-9c87-8b3fd6f97e4e"
              }
            ],
            "metricValue": 7.727
          }
        ]
      }
    }
  }
}


stress --cpu 2 --timeout 60000

ğŸš¨ Azure Monitor å‘Šè­¦é€šçŸ¥

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸ“‹ åŸºæœ¬ä¿¡æ¯
   ğŸ”” å‘Šè­¦è§„åˆ™: @{triggerBody()?['data']?['essentials']?['alertRule']}
   âš ï¸ ä¸¥é‡çº§åˆ«: @{triggerBody()?['data']?['essentials']?['severity']}
   ğŸ“Š çŠ¶æ€: @{triggerBody()?['data']?['essentials']?['monitorCondition']}
   ğŸ• è§¦å‘æ—¶é—´: @{triggerBody()?['data']?['essentials']?['firedDateTime']}

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸ–¥ï¸ ç›®æ ‡èµ„æº
   ğŸ’» èµ„æºåç§°: @{triggerBody()?['data']?['essentials']?['configurationItems']?[0]}
   ğŸ“ æè¿°: @{triggerBody()?['data']?['essentials']?['description']}

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸ“ˆ è§¦å‘æ¡ä»¶
   ğŸ“ æŒ‡æ ‡: @{triggerBody()?['data']?['alertContext']?['condition']?['allOf']?[0]?['metricName']}
   ğŸ”¢ è¿ç®—ç¬¦: @{triggerBody()?['data']?['alertContext']?['condition']?['allOf']?[0]?['operator']}
   ğŸ¯ é˜ˆå€¼: @{triggerBody()?['data']?['alertContext']?['condition']?['allOf']?[0]?['threshold']}
   ğŸ”¥ å½“å‰å€¼: @{triggerBody()?['data']?['alertContext']?['condition']?['allOf']?[0]?['metricValue']}

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸ”— Azure Portal: https://portal.azure.com




# === 0) ç¡®è®¤å½“å‰å·¥ä½œç›®å½•å°±æ˜¯ä½ æƒ³å¯¼å‡ºçš„ç›®å½•ï¼ˆå¯é€‰æŸ¥çœ‹ï¼‰ ===
Get-Location

# === 1) åˆ›å»ºæ ¹è¯ä¹¦ï¼ˆè‡ªç­¾ï¼‰===
$rootCert = New-SelfSignedCertificate -Type Custom `
  -Subject 'CN=P2SRootCert' `
  -KeySpec Signature `
  -KeyExportPolicy Exportable `
  -KeyLength 2048 `
  -HashAlgorithm sha256 `
  -NotAfter (Get-Date).AddMonths(240) `
  -KeyUsage CertSign `
  -KeyUsageProperty Sign `
  -CertStoreLocation 'Cert:\CurrentUser\My'

# === 2) ç”¨æ ¹è¯ä¹¦ç­¾å‘å®¢æˆ·ç«¯è¯ä¹¦ï¼ˆå¿…é¡»åŒ…å« Client Authentication EKUï¼‰===
$clientCert = New-SelfSignedCertificate -Type Custom `
  -Subject 'CN=P2SChildCert' `
  -DnsName 'P2SChildCert' `
  -KeySpec Signature `
  -KeyExportPolicy Exportable `
  -KeyLength 2048 `
  -HashAlgorithm sha256 `
  -NotAfter (Get-Date).AddMonths(240) `
  -CertStoreLocation 'Cert:\CurrentUser\My' `
  -Signer $rootCert `
  -TextExtension @('2.5.29.37={text}1.3.6.1.5.5.7.3.2')  # EKU: Client Authentication

# === 3) å¯¼å‡ºæ ¹è¯ä¹¦ï¼ˆä»…å…¬é’¥ .cerï¼‰åˆ°å½“å‰ç›®å½• ===
$cerPath = Join-Path (Get-Location) 'P2SRootCert.cer'
Export-Certificate -Cert $rootCert -FilePath $cerPath -Force | Out-Null
Write-Host "æ ¹è¯ä¹¦(.cer) å·²å¯¼å‡º: $cerPath" -ForegroundColor Green

# === 4) å¯¼å‡ºå®¢æˆ·ç«¯è¯ä¹¦ï¼ˆå«ç§é’¥ .pfxï¼‰åˆ°å½“å‰ç›®å½• ===
$pfxPath = Join-Path (Get-Location) 'P2SChildCert.pfx'
$pwd = Read-Host -AsSecureString "ä¸º .pfx è®¾ç½®å¯†ç "
Export-PfxCertificate -Cert $clientCert -FilePath $pfxPath -Password $pwd | Out-Null
Write-Host "å®¢æˆ·ç«¯è¯ä¹¦(.pfx) å·²å¯¼å‡º: $pfxPath" -ForegroundColor Green

# === 5) å¯é€‰ï¼šæ‰“å°è¯ä¹¦ä¿¡æ¯ç¡®è®¤ ===
$rootCert  | Format-List Subject,Thumbprint,HasPrivateKey,PSParentPath
$clientCert| Format-List Subject,Thumbprint,HasPrivateKey,PSParentPath
